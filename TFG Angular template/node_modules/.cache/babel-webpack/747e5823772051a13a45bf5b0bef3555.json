{"ast":null,"code":"'use strict';\n\nvar crypto = require('crypto'),\n    url = require('url'),\n    util = require('util'),\n    HttpParser = require('../http_parser'),\n    Base = require('./base'),\n    Hybi = require('./hybi'),\n    Proxy = require('./proxy');\n\nvar Client = function Client(_url, options) {\n  this.version = 'hybi-13';\n  Hybi.call(this, null, _url, options);\n  this.readyState = -1;\n  this._key = Client.generateKey();\n  this._accept = Hybi.generateAccept(this._key);\n  this._http = new HttpParser('response');\n  var uri = url.parse(this.url),\n      auth = uri.auth && new Buffer(uri.auth, 'utf8').toString('base64');\n  if (this.VALID_PROTOCOLS.indexOf(uri.protocol) < 0) throw new Error(this.url + ' is not a valid WebSocket URL');\n  this._pathname = (uri.pathname || '/') + (uri.search || '');\n\n  this._headers.set('Host', uri.host);\n\n  this._headers.set('Upgrade', 'websocket');\n\n  this._headers.set('Connection', 'Upgrade');\n\n  this._headers.set('Sec-WebSocket-Key', this._key);\n\n  this._headers.set('Sec-WebSocket-Version', '13');\n\n  if (this._protocols.length > 0) this._headers.set('Sec-WebSocket-Protocol', this._protocols.join(', '));\n  if (auth) this._headers.set('Authorization', 'Basic ' + auth);\n};\n\nutil.inherits(Client, Hybi);\n\nClient.generateKey = function () {\n  return crypto.randomBytes(16).toString('base64');\n};\n\nvar instance = {\n  VALID_PROTOCOLS: ['ws:', 'wss:'],\n  proxy: function proxy(origin, options) {\n    return new Proxy(this, origin, options);\n  },\n  start: function start() {\n    if (this.readyState !== -1) return false;\n\n    this._write(this._handshakeRequest());\n\n    this.readyState = 0;\n    return true;\n  },\n  parse: function parse(chunk) {\n    if (this.readyState === 3) return;\n    if (this.readyState > 0) return Hybi.prototype.parse.call(this, chunk);\n\n    this._http.parse(chunk);\n\n    if (!this._http.isComplete()) return;\n\n    this._validateHandshake();\n\n    if (this.readyState === 3) return;\n\n    this._open();\n\n    this.parse(this._http.body);\n  },\n  _handshakeRequest: function _handshakeRequest() {\n    var extensions = this._extensions.generateOffer();\n\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n    var start = 'GET ' + this._pathname + ' HTTP/1.1',\n        headers = [start, this._headers.toString(), ''];\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n  _failHandshake: function _failHandshake(message) {\n    message = 'Error during WebSocket handshake: ' + message;\n    this.readyState = 3;\n    this.emit('error', new Error(message));\n    this.emit('close', new Base.CloseEvent(this.ERRORS.protocol_error, message));\n  },\n  _validateHandshake: function _validateHandshake() {\n    this.statusCode = this._http.statusCode;\n    this.headers = this._http.headers;\n    if (this._http.statusCode !== 101) return this._failHandshake('Unexpected response code: ' + this._http.statusCode);\n    var headers = this._http.headers,\n        upgrade = headers['upgrade'] || '',\n        connection = headers['connection'] || '',\n        accept = headers['sec-websocket-accept'] || '',\n        protocol = headers['sec-websocket-protocol'] || '';\n    if (upgrade === '') return this._failHandshake(\"'Upgrade' header is missing\");\n    if (upgrade.toLowerCase() !== 'websocket') return this._failHandshake(\"'Upgrade' header value is not 'WebSocket'\");\n    if (connection === '') return this._failHandshake(\"'Connection' header is missing\");\n    if (connection.toLowerCase() !== 'upgrade') return this._failHandshake(\"'Connection' header value is not 'Upgrade'\");\n    if (accept !== this._accept) return this._failHandshake('Sec-WebSocket-Accept mismatch');\n    this.protocol = null;\n\n    if (protocol !== '') {\n      if (this._protocols.indexOf(protocol) < 0) return this._failHandshake('Sec-WebSocket-Protocol mismatch');else this.protocol = protocol;\n    }\n\n    try {\n      this._extensions.activate(this.headers['sec-websocket-extensions']);\n    } catch (e) {\n      return this._failHandshake(e.message);\n    }\n  }\n};\n\nfor (var key in instance) {\n  Client.prototype[key] = instance[key];\n}\n\nmodule.exports = Client;","map":{"version":3,"sources":["/home/juanma/Documentos/TecladoVirtual/TFG Angular template/node_modules/websocket-driver/lib/websocket/driver/client.js"],"names":["crypto","require","url","util","HttpParser","Base","Hybi","Proxy","Client","_url","options","version","call","readyState","_key","generateKey","_accept","generateAccept","_http","uri","parse","auth","Buffer","toString","VALID_PROTOCOLS","indexOf","protocol","Error","_pathname","pathname","search","_headers","set","host","_protocols","length","join","inherits","randomBytes","instance","proxy","origin","start","_write","_handshakeRequest","chunk","prototype","isComplete","_validateHandshake","_open","body","extensions","_extensions","generateOffer","headers","_failHandshake","message","emit","CloseEvent","ERRORS","protocol_error","statusCode","upgrade","connection","accept","toLowerCase","activate","e","key","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar crypto     = require('crypto'),\n    url        = require('url'),\n    util       = require('util'),\n    HttpParser = require('../http_parser'),\n    Base       = require('./base'),\n    Hybi       = require('./hybi'),\n    Proxy      = require('./proxy');\n\nvar Client = function(_url, options) {\n  this.version = 'hybi-13';\n  Hybi.call(this, null, _url, options);\n\n  this.readyState = -1;\n  this._key       = Client.generateKey();\n  this._accept    = Hybi.generateAccept(this._key);\n  this._http      = new HttpParser('response');\n\n  var uri  = url.parse(this.url),\n      auth = uri.auth && new Buffer(uri.auth, 'utf8').toString('base64');\n\n  if (this.VALID_PROTOCOLS.indexOf(uri.protocol) < 0)\n    throw new Error(this.url + ' is not a valid WebSocket URL');\n\n  this._pathname = (uri.pathname || '/') + (uri.search || '');\n\n  this._headers.set('Host', uri.host);\n  this._headers.set('Upgrade', 'websocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('Sec-WebSocket-Key', this._key);\n  this._headers.set('Sec-WebSocket-Version', '13');\n\n  if (this._protocols.length > 0)\n    this._headers.set('Sec-WebSocket-Protocol', this._protocols.join(', '));\n\n  if (auth)\n    this._headers.set('Authorization', 'Basic ' + auth);\n};\nutil.inherits(Client, Hybi);\n\nClient.generateKey = function() {\n  return crypto.randomBytes(16).toString('base64');\n};\n\nvar instance = {\n  VALID_PROTOCOLS: ['ws:', 'wss:'],\n\n  proxy: function(origin, options) {\n    return new Proxy(this, origin, options);\n  },\n\n  start: function() {\n    if (this.readyState !== -1) return false;\n    this._write(this._handshakeRequest());\n    this.readyState = 0;\n    return true;\n  },\n\n  parse: function(chunk) {\n    if (this.readyState === 3) return;\n    if (this.readyState > 0) return Hybi.prototype.parse.call(this, chunk);\n\n    this._http.parse(chunk);\n    if (!this._http.isComplete()) return;\n\n    this._validateHandshake();\n    if (this.readyState === 3) return;\n\n    this._open();\n    this.parse(this._http.body);\n  },\n\n  _handshakeRequest: function() {\n    var extensions = this._extensions.generateOffer();\n    if (extensions)\n      this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n    var start   = 'GET ' + this._pathname + ' HTTP/1.1',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _failHandshake: function(message) {\n    message = 'Error during WebSocket handshake: ' + message;\n    this.readyState = 3;\n    this.emit('error', new Error(message));\n    this.emit('close', new Base.CloseEvent(this.ERRORS.protocol_error, message));\n  },\n\n  _validateHandshake: function() {\n    this.statusCode = this._http.statusCode;\n    this.headers    = this._http.headers;\n\n    if (this._http.statusCode !== 101)\n      return this._failHandshake('Unexpected response code: ' + this._http.statusCode);\n\n    var headers    = this._http.headers,\n        upgrade    = headers['upgrade'] || '',\n        connection = headers['connection'] || '',\n        accept     = headers['sec-websocket-accept'] || '',\n        protocol   = headers['sec-websocket-protocol'] || '';\n\n    if (upgrade === '')\n      return this._failHandshake(\"'Upgrade' header is missing\");\n    if (upgrade.toLowerCase() !== 'websocket')\n      return this._failHandshake(\"'Upgrade' header value is not 'WebSocket'\");\n\n    if (connection === '')\n      return this._failHandshake(\"'Connection' header is missing\");\n    if (connection.toLowerCase() !== 'upgrade')\n      return this._failHandshake(\"'Connection' header value is not 'Upgrade'\");\n\n    if (accept !== this._accept)\n      return this._failHandshake('Sec-WebSocket-Accept mismatch');\n\n    this.protocol = null;\n\n    if (protocol !== '') {\n      if (this._protocols.indexOf(protocol) < 0)\n        return this._failHandshake('Sec-WebSocket-Protocol mismatch');\n      else\n        this.protocol = protocol;\n    }\n\n    try {\n      this._extensions.activate(this.headers['sec-websocket-extensions']);\n    } catch (e) {\n      return this._failHandshake(e.message);\n    }\n  }\n};\n\nfor (var key in instance)\n  Client.prototype[key] = instance[key];\n\nmodule.exports = Client;\n"]},"metadata":{},"sourceType":"script"}