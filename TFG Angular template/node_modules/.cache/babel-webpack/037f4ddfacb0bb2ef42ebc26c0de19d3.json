{"ast":null,"code":"'use strict';\n\nvar crypto = require('crypto'),\n    util = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base = require('./base'),\n    Frame = require('./hybi/frame'),\n    Message = require('./hybi/message');\n\nvar Hybi = function Hybi(request, url, options) {\n  Base.apply(this, arguments);\n  this._extensions = new Extensions();\n  this._stage = 0;\n  this._masking = this._options.masking;\n  this._protocols = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks = {};\n  if (typeof this._protocols === 'string') this._protocols = this._protocols.split(/ *, */);\n  if (!this._request) return;\n  var secKey = this._request.headers['sec-websocket-key'],\n      protos = this._request.headers['sec-websocket-protocol'],\n      version = this._request.headers['sec-websocket-version'],\n      supported = this._protocols;\n\n  this._headers.set('Upgrade', 'websocket');\n\n  this._headers.set('Connection', 'Upgrade');\n\n  this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function (p) {\n      return supported.indexOf(p) >= 0;\n    })[0];\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n  }\n\n  this.version = 'hybi-' + version;\n};\n\nutil.inherits(Hybi, Base);\n\nHybi.mask = function (payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n\n  return payload;\n};\n\nHybi.generateAccept = function (key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\nvar instance = {\n  FIN: 0x80,\n  MASK: 0x80,\n  RSV1: 0x40,\n  RSV2: 0x20,\n  RSV3: 0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n  OPCODES: {\n    continuation: 0,\n    text: 1,\n    binary: 2,\n    close: 8,\n    ping: 9,\n    pong: 10\n  },\n  OPCODE_CODES: [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n  ERRORS: {\n    normal_closure: 1000,\n    going_away: 1001,\n    protocol_error: 1002,\n    unacceptable: 1003,\n    encoding_error: 1007,\n    policy_violation: 1008,\n    too_large: 1009,\n    extension_error: 1010,\n    unexpected_condition: 1011\n  },\n  ERROR_CODES: [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n  addExtension: function addExtension(extension) {\n    this._extensions.add(extension);\n\n    return true;\n  },\n  parse: function parse(chunk) {\n    this._reader.put(chunk);\n\n    var buffer = true;\n\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n\n          if (buffer) {\n            this._stage = 0;\n\n            this._emitFrame(buffer);\n          }\n\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n  text: function text(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n  binary: function binary(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n  ping: function ping(message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n  pong: function pong(message) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    return this.frame(message, 'pong');\n  },\n  close: function close(reason, code) {\n    reason = reason || '';\n    code = code || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n\n      this._extensions.close(function () {\n        this.frame(reason, 'close', code);\n      }, this);\n\n      return true;\n    } else {\n      return false;\n    }\n  },\n  frame: function frame(buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n    if (buffer instanceof Array) buffer = new Buffer(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n    var message = new Message(),\n        isText = typeof buffer === 'string',\n        payload,\n        copy;\n    message.rsv1 = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n    payload = isText ? new Buffer(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = new Buffer(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n\n    message.data = payload;\n\n    var onMessageReady = function onMessageReady(message) {\n      var frame = new Frame();\n      frame.final = true;\n      frame.rsv1 = message.rsv1;\n      frame.rsv2 = message.rsv2;\n      frame.rsv3 = message.rsv3;\n      frame.opcode = message.opcode;\n      frame.masked = !!this._masking;\n      frame.length = message.data.length;\n      frame.payload = message.data;\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0) this._extensions.processOutgoingMessage(message, function (error, message) {\n      if (error) return this._fail('extension_error', error.message);\n      onMessageReady.call(this, message);\n    }, this);else onMessageReady.call(this, message);\n    return true;\n  },\n  _sendFrame: function _sendFrame(frame) {\n    var length = frame.length,\n        header = length <= 125 ? 2 : length <= 65535 ? 4 : 10,\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = new Buffer(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n    buffer[0] = (frame.final ? this.FIN : 0) | (frame.rsv1 ? this.RSV1 : 0) | (frame.rsv2 ? this.RSV2 : 0) | (frame.rsv3 ? this.RSV3 : 0) | frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    frame.payload.copy(buffer, offset);\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(buffer, frame.maskingKey, offset);\n    }\n\n    this._write(buffer);\n  },\n  _handshakeResponse: function _handshakeResponse() {\n    try {\n      var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n    } catch (e) {\n      return this._fail('protocol_error', e.message);\n    }\n\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n    var start = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n  _shutdown: function _shutdown(code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n    var sendCloseFrame = this.readyState === 1;\n    this.readyState = 2;\n\n    this._extensions.close(function () {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n  _fail: function _fail(type, message) {\n    if (this.readyState > 1) return;\n\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n  _parseOpcode: function _parseOpcode(octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function (rsv) {\n      return (octet & rsv) === rsv;\n    });\n    var frame = this._frame = new Frame();\n    frame.final = (octet & this.FIN) === this.FIN;\n    frame.rsv1 = rsvs[0];\n    frame.rsv2 = rsvs[1];\n    frame.rsv3 = rsvs[2];\n    frame.opcode = octet & this.OPCODE;\n    this._stage = 1;\n    if (!this._extensions.validFrameRsv(frame)) return this._fail('protocol_error', 'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) + ', reserved2 = ' + (frame.rsv2 ? 1 : 0) + ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0) return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final) return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0) return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n  _parseLength: function _parseLength(octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = octet & this.LENGTH;\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = frame.length === 126 ? 2 : 8;\n    }\n\n    if (this._requireMasking && !frame.masked) return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n  _parseExtendedLength: function _parseExtendedLength(buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n    this._stage = frame.masked ? 3 : 4;\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125) return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n    if (!this._checkFrameLength()) return;\n  },\n  _checkFrameLength: function _checkFrameLength() {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n\n      return false;\n    } else {\n      return true;\n    }\n  },\n  _emitFrame: function _emitFrame(buffer) {\n    var frame = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode = frame.opcode,\n        message,\n        code,\n        reason,\n        callbacks,\n        callback;\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0) return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code = payload.length >= 2 ? payload.readUInt16BE(0) : null;\n      reason = payload.length > 2 ? this._encode(payload.slice(2)) : null;\n      if (!(payload.length === 0) && !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) && this.ERROR_CODES.indexOf(code) < 0) code = this.ERRORS.protocol_error;\n      if (payload.length > 125 || payload.length > 2 && !reason) code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message = this._encode(payload);\n      callback = callbacks[message];\n      delete callbacks[message];\n      if (callback) callback();\n    }\n  },\n  _emitMessage: function _emitMessage(message) {\n    var message = this._message;\n    message.read();\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function (error, message) {\n      if (error) return this._fail('extension_error', error.message);\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n      if (payload === null) return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');else this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n  _encode: function _encode(buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n  _readUInt: function _readUInt(buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n    return buffer.readUInt32BE(0) * 0x100000000 + buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance) {\n  Hybi.prototype[key] = instance[key];\n}\n\nmodule.exports = Hybi;","map":{"version":3,"sources":["/home/juanma/Documentos/TecladoVirtual/TFG Angular template/node_modules/websocket-driver/lib/websocket/driver/hybi.js"],"names":["crypto","require","util","Extensions","Base","Frame","Message","Hybi","request","url","options","apply","arguments","_extensions","_stage","_masking","_options","masking","_protocols","protocols","_requireMasking","requireMasking","_pingCallbacks","split","_request","secKey","headers","protos","version","supported","_headers","set","generateAccept","undefined","protocol","filter","p","indexOf","inherits","mask","payload","offset","length","i","n","key","sha1","createHash","update","GUID","digest","instance","FIN","MASK","RSV1","RSV2","RSV3","OPCODE","LENGTH","OPCODES","continuation","text","binary","close","ping","pong","OPCODE_CODES","MESSAGE_OPCODES","OPENING_OPCODES","ERRORS","normal_closure","going_away","protocol_error","unacceptable","encoding_error","policy_violation","too_large","extension_error","unexpected_condition","ERROR_CODES","DEFAULT_ERROR_CODE","MIN_RESERVED_ERROR","MAX_RESERVED_ERROR","UTF8_MATCH","addExtension","extension","add","parse","chunk","_reader","put","buffer","read","_parseOpcode","_parseLength","_frame","lengthBytes","_parseExtendedLength","maskingKey","_emitFrame","message","readyState","frame","callback","reason","code","emit","CloseEvent","type","_queue","Array","Buffer","toString","isText","copy","rsv1","rsv2","rsv3","opcode","writeUInt16BE","data","onMessageReady","final","masked","randomBytes","_sendFrame","processOutgoingMessage","error","_fail","call","header","writeUInt32BE","Math","floor","_write","_handshakeResponse","extensions","generateResponse","e","start","join","_shutdown","_message","sendCloseFrame","Error","octet","rsvs","map","rsv","validFrameRsv","_checkFrameLength","_readUInt","_maxLength","callbacks","pushFrame","_emitMessage","readUInt16BE","_encode","slice","processIncomingMessage","MessageEvent","string","test","readUInt32BE","prototype","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar crypto     = require('crypto'),\n    util       = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base       = require('./base'),\n    Frame      = require('./hybi/frame'),\n    Message    = require('./hybi/message');\n\nvar Hybi = function(request, url, options) {\n  Base.apply(this, arguments);\n\n  this._extensions     = new Extensions();\n  this._stage          = 0;\n  this._masking        = this._options.masking;\n  this._protocols      = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks  = {};\n\n  if (typeof this._protocols === 'string')\n    this._protocols = this._protocols.split(/ *, */);\n\n  if (!this._request) return;\n\n  var secKey    = this._request.headers['sec-websocket-key'],\n      protos    = this._request.headers['sec-websocket-protocol'],\n      version   = this._request.headers['sec-websocket-version'],\n      supported = this._protocols;\n\n  this._headers.set('Upgrade', 'websocket');\n  this._headers.set('Connection', 'Upgrade');\n  this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function(p) { return supported.indexOf(p) >= 0 })[0];\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n  }\n\n  this.version = 'hybi-' + version;\n};\nutil.inherits(Hybi, Base);\n\nHybi.mask = function(payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n  return payload;\n};\n\nHybi.generateAccept = function(key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n\nvar instance = {\n  FIN:    0x80,\n  MASK:   0x80,\n  RSV1:   0x40,\n  RSV2:   0x20,\n  RSV3:   0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n\n  OPCODES: {\n    continuation: 0,\n    text:         1,\n    binary:       2,\n    close:        8,\n    ping:         9,\n    pong:         10\n  },\n\n  OPCODE_CODES:    [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n\n  ERRORS: {\n    normal_closure:       1000,\n    going_away:           1001,\n    protocol_error:       1002,\n    unacceptable:         1003,\n    encoding_error:       1007,\n    policy_violation:     1008,\n    too_large:            1009,\n    extension_error:      1010,\n    unexpected_condition: 1011\n  },\n\n  ERROR_CODES:        [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n\n  addExtension: function(extension) {\n    this._extensions.add(extension);\n    return true;\n  },\n\n  parse: function(chunk) {\n    this._reader.put(chunk);\n    var buffer = true;\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n          if (buffer) {\n            this._stage = 0;\n            this._emitFrame(buffer);\n          }\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n\n  text: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n\n  binary: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n\n  ping: function(message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n\n  pong: function(message) {\n      if (this.readyState > 1) return false;\n      message = message ||'';\n      return this.frame(message, 'pong');\n  },\n\n  close: function(reason, code) {\n    reason = reason || '';\n    code   = code   || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n      this._extensions.close(function() { this.frame(reason, 'close', code) }, this);\n      return true;\n    } else {\n      return false;\n    }\n  },\n\n  frame: function(buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n\n    if (buffer instanceof Array)    buffer = new Buffer(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n\n    var message = new Message(),\n        isText  = (typeof buffer === 'string'),\n        payload, copy;\n\n    message.rsv1   = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n\n    payload = isText ? new Buffer(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = new Buffer(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n    message.data = payload;\n\n    var onMessageReady = function(message) {\n      var frame = new Frame();\n\n      frame.final   = true;\n      frame.rsv1    = message.rsv1;\n      frame.rsv2    = message.rsv2;\n      frame.rsv3    = message.rsv3;\n      frame.opcode  = message.opcode;\n      frame.masked  = !!this._masking;\n      frame.length  = message.data.length;\n      frame.payload = message.data;\n\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0)\n      this._extensions.processOutgoingMessage(message, function(error, message) {\n        if (error) return this._fail('extension_error', error.message);\n        onMessageReady.call(this, message);\n      }, this);\n    else\n      onMessageReady.call(this, message);\n\n    return true;\n  },\n\n  _sendFrame: function(frame) {\n    var length = frame.length,\n        header = (length <= 125) ? 2 : (length <= 65535 ? 4 : 10),\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = new Buffer(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n\n    buffer[0] = (frame.final ? this.FIN : 0) |\n                (frame.rsv1 ? this.RSV1 : 0) |\n                (frame.rsv2 ? this.RSV2 : 0) |\n                (frame.rsv3 ? this.RSV3 : 0) |\n                frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    frame.payload.copy(buffer, offset);\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(buffer, frame.maskingKey, offset);\n    }\n\n    this._write(buffer);\n  },\n\n  _handshakeResponse: function() {\n    try {\n      var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n    } catch (e) {\n      return this._fail('protocol_error', e.message);\n    }\n\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n    var start   = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n\n    return new Buffer(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _shutdown: function(code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n\n    var sendCloseFrame = (this.readyState === 1);\n    this.readyState = 2;\n\n    this._extensions.close(function() {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n\n  _fail: function(type, message) {\n    if (this.readyState > 1) return;\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n\n  _parseOpcode: function(octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function(rsv) {\n      return (octet & rsv) === rsv;\n    });\n\n    var frame = this._frame = new Frame();\n\n    frame.final  = (octet & this.FIN) === this.FIN;\n    frame.rsv1   = rsvs[0];\n    frame.rsv2   = rsvs[1];\n    frame.rsv3   = rsvs[2];\n    frame.opcode = (octet & this.OPCODE);\n\n    this._stage = 1;\n\n    if (!this._extensions.validFrameRsv(frame))\n      return this._fail('protocol_error',\n          'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) +\n          ', reserved2 = ' + (frame.rsv2 ? 1 : 0) +\n          ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0)\n      return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final)\n      return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0)\n      return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n\n  _parseLength: function(octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = (octet & this.LENGTH);\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = (frame.length === 126 ? 2 : 8);\n    }\n\n    if (this._requireMasking && !frame.masked)\n      return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n\n  _parseExtendedLength: function(buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n\n    this._stage = frame.masked ? 3 : 4;\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125)\n      return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n\n    if (!this._checkFrameLength()) return;\n  },\n\n  _checkFrameLength: function() {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n      return false;\n    } else {\n      return true;\n    }\n  },\n\n  _emitFrame: function(buffer) {\n    var frame   = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode  = frame.opcode,\n        message,\n        code, reason,\n        callbacks, callback;\n\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0)\n      return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code   = (payload.length >= 2) ? payload.readUInt16BE(0) : null;\n      reason = (payload.length > 2) ? this._encode(payload.slice(2)) : null;\n\n      if (!(payload.length === 0) &&\n          !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) &&\n          this.ERROR_CODES.indexOf(code) < 0)\n        code = this.ERRORS.protocol_error;\n\n      if (payload.length > 125 || (payload.length > 2 && !reason))\n        code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message   = this._encode(payload);\n      callback  = callbacks[message];\n\n      delete callbacks[message];\n      if (callback) callback()\n    }\n  },\n\n  _emitMessage: function(message) {\n    var message = this._message;\n    message.read();\n\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function(error, message) {\n      if (error) return this._fail('extension_error', error.message);\n\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n\n      if (payload === null)\n        return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');\n      else\n        this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n\n  _encode: function(buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n\n  _readUInt: function(buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n\n    return buffer.readUInt32BE(0) * 0x100000000 +\n           buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance)\n  Hybi.prototype[key] = instance[key];\n\nmodule.exports = Hybi;\n"]},"metadata":{},"sourceType":"script"}